

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<script src="/live2d-widget/autoload.js"></script>
<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="KotRin">
  <meta name="keywords" content="">
  
    <meta name="description" content="最后更新于：2025&#x2F;7&#x2F;18 PM            闲话环节 今天没有闲话。。。。 一、用户传图审核 需求分析 1）用户上传图片，需要开放权限，也需要像管理员一样添加文件校验 2）添加审核机制，管理员可以查看到用户上传的图片信息，标记通过或者拒绝 方案设计  明确审核逻辑 设置库表结构  1、审核逻辑 1）审核状态转换 管理员可以将拒绝的请求改为通过，反之 2）自">
<meta property="og:type" content="article">
<meta property="og:title" content="澄观云谱5-用户传图">
<meta property="og:url" content="https://korinall.github.io/2025/07/18/%E6%BE%84%E8%A7%82%E4%BA%91%E8%B0%B105/index.html">
<meta property="og:site_name" content="KRL">
<meta property="og:description" content="最后更新于：2025&#x2F;7&#x2F;18 PM            闲话环节 今天没有闲话。。。。 一、用户传图审核 需求分析 1）用户上传图片，需要开放权限，也需要像管理员一样添加文件校验 2）添加审核机制，管理员可以查看到用户上传的图片信息，标记通过或者拒绝 方案设计  明确审核逻辑 设置库表结构  1、审核逻辑 1）审核状态转换 管理员可以将拒绝的请求改为通过，反之 2）自">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250718153633152.png">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250718175408869.png">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250718175928544.png">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250718181030548.png">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250718182100989.png">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250719115455843.png">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250719115822048.png">
<meta property="og:image" content="https://korinall.github.io/img/pictureLibrary/image-20250719121442242.png">
<meta property="article:published_time" content="2025-07-18T14:02:54.000Z">
<meta property="article:modified_time" content="2025-07-25T13:08:00.505Z">
<meta property="article:author" content="KotRin">
<meta property="article:tag" content="项目实战">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://korinall.github.io/img/pictureLibrary/image-20250718153633152.png">
  
  
  
  <title>澄观云谱5-用户传图 - KRL</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/shubiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/gradient.css">
<link rel="stylesheet" href="/css/macpanel.css">
<link rel="stylesheet" href="/css/reward.css">
<link rel="stylesheet" href="/css/APlayer.min.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"korinall.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong class="navbar-title">岚码集隅</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                <span>文章</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/archives/" target="_self">
                    <i class="iconfont icon-archive-fill"></i>
                    <span>归档</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/" target="_self">
                    <i class="iconfont icon-category-fill"></i>
                    <span>分类</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/tags/" target="_self">
                    <i class="iconfont icon-tags-fill"></i>
                    <span>标签</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-user-fill""></i>
                <span>个人</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/about/" target="_self">
                    <i class="iconfont icon-archive-fill"></i>
                    <span>关于</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/music/" target="_self">
                    <i class="iconfont icon-music"></i>
                    <span>歌单</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/repo/" target="_self">
                    <i class="iconfont icon-gitee-fill"></i>
                    <span>仓库</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/site_map" target="_self">
                <i class="iconfont icon-code""></i>
                <span>导航</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-kakao-talk-fill"></i>
                <span>社交</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/rss/" target="_self">
                    <i class="iconfont icon-rss-fill"></i>
                    <span>RSS订阅</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/shuoshuo/" target="_self">
                    <i class="iconfont icon-comment"></i>
                    <span>说说</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-steam""></i>
                <span>游戏</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/game/" target="_self">
                    <i class="iconfont icon-bookmark-fill"></i>
                    <span>收藏</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-codepen-fill""></i>
                <span>工具</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/calculator/" target="_self">
                    <i class="iconfont icon-copyright"></i>
                    <span>计算器</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/hkd.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="澄观云谱5-用户传图"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-18 22:02" pubdate>
          2025年7月18日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          49 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">澄观云谱5-用户传图</h1>
            
            
              <div class="markdown-body">
                
                <div class="note note-info">
            <p>最后更新于：2025/7/18 PM</p>
          </div>
<h1 id="闲话环节">闲话环节</h1>
<p>今天没有闲话。。。。</p>
<h2 id="一用户传图审核">一、用户传图审核</h2>
<h3 id="需求分析">需求分析</h3>
<p>1）用户上传图片，需要开放权限，也需要像管理员一样添加文件校验</p>
<p>2）添加审核机制，管理员可以查看到用户上传的图片信息，标记通过或者拒绝</p>
<h3 id="方案设计">方案设计</h3>
<ul>
<li>明确审核逻辑</li>
<li>设置库表结构</li>
</ul>
<h4 id="审核逻辑">1、审核逻辑</h4>
<p>1）审核状态转换</p>
<p>管理员可以将拒绝的请求改为通过，反之</p>
<p>2）自动过审</p>
<p>管理员自己创建的图片直接上传成功，同时填充信息</p>
<p>3）用户操作重置状态</p>
<p>用户在编辑和上传图片，需要将图片的状态改为待审核</p>
<p>4）控制内容可见性</p>
<p>用户只能查看到审核通过的图片，而管理员可以看到所有信息</p>
<p><strong>并发问题是否需要考虑？</strong></p>
<p>答案是不需要，因为审核都是管理员手动完成，不存在高并发的场景</p>
<h4 id="库表设计">2、库表设计</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> picture  <br>    <span class="hljs-comment">-- 添加新列  </span><br>    <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> reviewStatus <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核状态：0-待审核; 1-通过; 2-拒绝&#x27;</span>,  <br>    <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> reviewMessage <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">512</span>) <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核信息&#x27;</span>,  <br>    <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> reviewerId <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核人 ID&#x27;</span>,  <br>    <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> reviewTime DATETIME <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;审核时间&#x27;</span>;  <br>  <br><span class="hljs-comment">-- 创建基于 reviewStatus 列的索引  </span><br><span class="hljs-keyword">CREATE</span> INDEX idx_reviewStatus <span class="hljs-keyword">ON</span> picture (reviewStatus);<br><br></code></pre></td></tr></table></figure>
<p>注意：</p>
<p>使用INT标记每一种审核状态，而不是字符串效率低</p>
<p>后期需要通过审核状态查询，添加索引</p>
<h3 id="后端开发">后端开发</h3>
<h4 id="数据模型开发">1、数据模型开发</h4>
<p>1）Picture新增字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 状态：0-待审核; 1-通过; 2-拒绝  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">private</span> Integer reviewStatus;  <br>  <br><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 审核信息  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">private</span> String reviewMessage;  <br>  <br><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 审核人 id  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">private</span> Long reviewerId;  <br>  <br><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 审核时间  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">private</span> Date reviewTime;<br><br></code></pre></td></tr></table></figure>
<p>2）图片查询请求新增</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 状态：0-待审核; 1-通过; 2-拒绝  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">private</span> Integer reviewStatus;  <br>  <br><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 审核信息  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">private</span> String reviewMessage;  <br>  <br><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 审核人 id  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">private</span> Long reviewerId;<br><br></code></pre></td></tr></table></figure>
<p>3）新增审核状态枚举类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Getter</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PictureReviewStatusEnum</span> &#123;  <br>    REVIEWING(<span class="hljs-string">&quot;待审核&quot;</span>, <span class="hljs-number">0</span>),  <br>    PASS(<span class="hljs-string">&quot;通过&quot;</span>, <span class="hljs-number">1</span>),  <br>    REJECT(<span class="hljs-string">&quot;拒绝&quot;</span>, <span class="hljs-number">2</span>);  <br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String text;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;  <br>  <br>    PictureReviewStatusEnum(String text, <span class="hljs-type">int</span> value) &#123;  <br>        <span class="hljs-built_in">this</span>.text = text;  <br>        <span class="hljs-built_in">this</span>.value = value;  <br>    &#125;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 根据 value 获取枚举  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PictureReviewStatusEnum <span class="hljs-title function_">getEnumByValue</span><span class="hljs-params">(Integer value)</span> &#123;  <br>        <span class="hljs-keyword">if</span> (ObjUtil.isEmpty(value)) &#123;  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>        &#125;  <br>        <span class="hljs-keyword">for</span> (PictureReviewStatusEnum pictureReviewStatusEnum : PictureReviewStatusEnum.values()) &#123;  <br>            <span class="hljs-keyword">if</span> (pictureReviewStatusEnum.value == value) &#123;  <br>                <span class="hljs-keyword">return</span> pictureReviewStatusEnum;  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>    &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<h4 id="管理员审核功能">2、管理员审核功能</h4>
<p>1）开发请求包装类，包含审核图片ID、<code>reviewStatus</code>、<code>reviewMessage</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureReviewRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * id  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">private</span> Long id;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 状态：0-待审核, 1-通过, 2-拒绝  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">private</span> Integer reviewStatus;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 审核信息  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">private</span> String reviewMessage;  <br>  <br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>2）开发审核服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">doPictureReview</span><span class="hljs-params">(PictureReviewRequest pictureReviewRequest, User loginUser)</span>;<br></code></pre></td></tr></table></figure>
<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPictureReview</span><span class="hljs-params">(PictureReviewRequest pictureReviewRequest, User loginUser)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> pictureReviewRequest.getId();<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">reviewStatus</span> <span class="hljs-operator">=</span> pictureReviewRequest.getReviewStatus();<br>        <span class="hljs-type">PictureReviewStatusEnum</span> <span class="hljs-variable">reviewStatusEnum</span> <span class="hljs-operator">=</span> PictureReviewStatusEnum.getEnumByValue(reviewStatus);<br><br>        <span class="hljs-keyword">if</span>(id == <span class="hljs-literal">null</span> || reviewStatusEnum == <span class="hljs-literal">null</span> || PictureReviewStatusEnum.REVIEWING.equals(reviewStatus)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.PARAMS_ERROR);<br>        &#125;<br><br>        <span class="hljs-type">Picture</span> <span class="hljs-variable">oldPicture</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(id);<br>        ThrowUtils.throwIf(oldPicture == <span class="hljs-literal">null</span>,ErrorCode.PARAMS_ERROR);<br><br>        <span class="hljs-keyword">if</span>(oldPicture.getReviewStatus().equals(reviewStatus)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;请勿重复审核&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-type">Picture</span> <span class="hljs-variable">updatePicture</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Picture</span>();<br>        BeanUtils.copyProperties(pictureReviewRequest,updatePicture);<br>        updatePicture.setReviewerId(loginUser.getId());<br>        updatePicture.setReviewTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.updateById(updatePicture);<br>        ThrowUtils.throwIf(!res,ErrorCode.OPERATION_ERROR);<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>3）开发审核接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/review&quot;)</span>  <br><span class="hljs-meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span>  <br><span class="hljs-keyword">public</span> BaseResponse&lt;Boolean&gt; <span class="hljs-title function_">doPictureReview</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> PictureReviewRequest pictureReviewRequest,  </span><br><span class="hljs-params">                                             HttpServletRequest request)</span> &#123;  <br>    ThrowUtils.throwIf(pictureReviewRequest == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR);  <br>    <span class="hljs-type">User</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> userService.getLoginUser(request);  <br>    pictureService.doPictureReview(pictureReviewRequest, loginUser);  <br>    <span class="hljs-keyword">return</span> ResultUtils.success(<span class="hljs-literal">true</span>);  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<h4 id="审核状态设置">3、审核状态设置</h4>
<p>1）权限控制</p>
<p>由于图片上传也是支持图片编辑功能的，需要做好编辑权限控制(仅本人和管理员)</p>
<p>修改uploadPicture方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (pictureId != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Picture</span> <span class="hljs-variable">oldPicture</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(pictureId);<br>            ThrowUtils.throwIf(oldPicture == <span class="hljs-literal">null</span>, ErrorCode.NOT_FOUND_ERROR,<span class="hljs-string">&quot;图片不存在&quot;</span>);<br><br>            <span class="hljs-keyword">if</span>(!oldPicture.getUserId().equals(loginUser.getId()) || !UserConstant.ADMIN_ROLE.equals(loginUser.getUserRole())) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NO_AUTH_ERROR);<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure>
<p>2）设置审核状态</p>
<p>管理员自动过审，同时填充审核参数；用户上传或编辑图片，审核状态改为待审核</p>
<p>由于填充审核参数管理员用户都需要使用，这里写一个通用的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fillReviewParams</span><span class="hljs-params">(Picture picture, User loginUser)</span> &#123;  <br>    <span class="hljs-keyword">if</span> (userService.isAdmin(loginUser)) &#123;  <br>        <span class="hljs-comment">// 管理员自动过审  </span><br>        picture.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());  <br>        picture.setReviewerId(loginUser.getId());  <br>        picture.setReviewMessage(<span class="hljs-string">&quot;管理员自动过审&quot;</span>);  <br>        picture.setReviewTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 非管理员，创建或编辑都要改为待审核  </span><br>        picture.setReviewStatus(PictureReviewStatusEnum.REVIEWING.getValue());  <br>    &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>分别给需要使用的方法调用通用接口</p>
<p>修改updatePicture接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> pictureUpdateRequest.getId();<br><span class="hljs-type">Picture</span> <span class="hljs-variable">oldPicture</span> <span class="hljs-operator">=</span> pictureService.getById(id);<br>ThrowUtils.throwIf(oldPicture == <span class="hljs-literal">null</span>, ErrorCode.NOT_FOUND_ERROR);<br><br><span class="hljs-type">User</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> userService.getLoginUser(request);<br>pictureService.fillReviewParams(oldPicture,loginUser);<br><br><span class="hljs-comment">// 操作数据库</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pictureService.updateById(picture);<br>ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);<br></code></pre></td></tr></table></figure>
<p>修改editPicture接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!oldPicture.getUserId().equals(loginUser.getId()) &amp;&amp; !userService.isAdmin(loginUser)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NO_AUTH_ERROR);<br>        &#125;<br>pictureService.fillReviewParams(oldPicture,loginUser);<br></code></pre></td></tr></table></figure>
<p>修改上传图片服务实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">picture.setPicFormat(uploadPictureResult.getPicFormat());<br>picture.setUserId(loginUser.getId());<br>fillReviewParams(picture,loginUser);<br><span class="hljs-comment">// 如果 pictureId 不为空，表示更新，否则是新增</span><br><span class="hljs-keyword">if</span> (pictureId != <span class="hljs-literal">null</span>) &#123;<br>  <span class="hljs-comment">// 如果是更新，需要补充 id 和编辑时间</span><br>  picture.setId(pictureId);<br>  picture.setEditTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="控制内容可见性">4、控制内容可见性</h4>
<p>目前只有主页给用户看，保证用户看到的是过审的，数据又是从/list/page/vo接口中获得，所以修改listPictureVOByPage接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());<br>Page&lt;Picture&gt; picturePage = pictureService.page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size),<br>	pictureService.getQueryWrapper(pictureQueryRequest));<br></code></pre></td></tr></table></figure>
<p>同时修改getQueryWrapper，确保查询条件正确</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Integer</span> <span class="hljs-variable">reviewStatus</span> <span class="hljs-operator">=</span> pictureQueryRequest.getReviewStatus();<br><span class="hljs-type">Long</span> <span class="hljs-variable">reviewerId</span> <span class="hljs-operator">=</span> pictureQueryRequest.getReviewerId();<br><span class="hljs-type">String</span> <span class="hljs-variable">reviewMessage</span> <span class="hljs-operator">=</span> pictureQueryRequest.getReviewMessage();<br>queryWrapper.eq(ObjUtil.isNotEmpty(reviewStatus),<span class="hljs-string">&quot;reviewStatus&quot;</span>,reviewStatus);<br>queryWrapper.eq(StrUtil.isNotBlank(reviewMessage),<span class="hljs-string">&quot;reviewMessage&quot;</span>,reviewMessage);<br>queryWrapper.eq(ObjUtil.isNotEmpty(reviewerId),<span class="hljs-string">&quot;reviewerId&quot;</span>,reviewerId);<br></code></pre></td></tr></table></figure>
<p>这样依赖，后端也也支持根据审核字段查询了</p>
<p>至此后端部分完成</p>
<h3 id="前端开发">前端开发</h3>
<p>控制首页展示审核通过已经通过后端实现，现在只需要开发审核页面即可</p>
<h4 id="定义审核常量">1、定义审核常量</h4>
<p>新建<code>constants/picture.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PIC_REVIEW_STATUS_ENUM</span> = &#123;  <br>  <span class="hljs-attr">REVIEWING</span>: <span class="hljs-number">0</span>,  <br>  <span class="hljs-attr">PASS</span>: <span class="hljs-number">1</span>,  <br>  <span class="hljs-attr">REJECT</span>: <span class="hljs-number">2</span>,  <br>&#125;  <br>  <br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PIC_REVIEW_STATUS_MAP</span> = &#123;  <br>  <span class="hljs-number">0</span>: <span class="hljs-string">&#x27;待审核&#x27;</span>,  <br>  <span class="hljs-number">1</span>: <span class="hljs-string">&#x27;通过&#x27;</span>,  <br>  <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;拒绝&#x27;</span>,  <br>&#125;  <br>  <br><span class="hljs-comment">//方便options 从其中取值</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PIC_REVIEW_STATUS_OPTIONS</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable constant_">PIC_REVIEW_STATUS_MAP</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> &#123;  <br>  <span class="hljs-keyword">return</span> &#123;  <br>    <span class="hljs-attr">label</span>: <span class="hljs-variable constant_">PIC_REVIEW_STATUS_MAP</span>[key],  <br>    <span class="hljs-attr">value</span>: key,  <br>  &#125;  <br>&#125;)<br><br></code></pre></td></tr></table></figure>
<h4 id="管理员审核">2、管理员审核</h4>
<p>1）column新增审核信息</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts">&#123;<br>  <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;审核状态&#x27;</span>,<br>  <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">&#x27;reviewMessage&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>2）自定义审核信息展示内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template v-if=&quot;column.dataIndex === &#x27;reviewMessage&#x27;&quot;&gt;<br>  &lt;div&gt;审核状态：&#123;&#123; PIC_REVIEW_STATUS_MAP[record.reviewStatus] &#125;&#125;&lt;/div&gt;<br>  &lt;div&gt;审核信息：&#123;&#123; record.reviewMessage &#125;&#125;&lt;/div&gt;<br>  &lt;div&gt;审核人：&#123;&#123; record.reviewerId &#125;&#125;&lt;/div&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure>
<p>3）添加过审和拒绝操作</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs ts">&lt;template v-<span class="hljs-keyword">else</span>-<span class="hljs-keyword">if</span>=<span class="hljs-string">&quot;column.key === &#x27;action&#x27;&quot;</span>&gt;  <br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">a-space</span> <span class="hljs-attr">wrap</span>&gt;</span>  </span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.PASS&quot;</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;link&quot;</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleReview(record, PIC_REVIEW_STATUS_ENUM.PASS)&quot;</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span>  </span><br><span class="language-xml">      通过  </span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>  </span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.REJECT&quot;</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;link&quot;</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">danger</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleReview(record, PIC_REVIEW_STATUS_ENUM.REJECT)&quot;</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span>  </span><br><span class="language-xml">      拒绝  </span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>  </span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;link&quot;</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">&quot;`/add_picture?id=$&#123;record.id&#125;`&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>  </span></span><br><span class="hljs-tag"><span class="language-xml">      &gt;</span>编辑  </span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>  </span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;link&quot;</span> <span class="hljs-attr">danger</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;doDelete(record.id)&quot;</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>  </span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">a-space</span>&gt;</span></span>  <br>&lt;/template&gt;<br><br></code></pre></td></tr></table></figure>
<p>4）编写审核函数</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReview</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"><span class="hljs-attr">record</span>: API.<span class="hljs-title class_">Picture</span>, <span class="hljs-attr">reviewStatus</span>: <span class="hljs-built_in">number</span></span>) =&gt; &#123;  <br>  <span class="hljs-keyword">const</span> reviewMessage = reviewStatus === <span class="hljs-variable constant_">PIC_REVIEW_STATUS_ENUM</span>.<span class="hljs-property">PASS</span> ? <span class="hljs-string">&#x27;管理员操作通过&#x27;</span> : <span class="hljs-string">&#x27;管理员操作拒绝&#x27;</span>  <br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">doPictureReviewUsingPost</span>(&#123;  <br>    <span class="hljs-attr">id</span>: record.<span class="hljs-property">id</span>,  <br>    reviewStatus,  <br>    reviewMessage,  <br>  &#125;)  <br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) &#123;  <br>    message.<span class="hljs-title function_">success</span>(<span class="hljs-string">&#x27;审核操作成功&#x27;</span>)  <br>    <span class="hljs-comment">// 重新获取列表  </span><br>    <span class="hljs-title function_">fetchData</span>()  <br>  &#125; <span class="hljs-keyword">else</span> &#123;  <br>    message.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;审核操作失败，&#x27;</span> + res.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>)  <br>  &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<h4 id="按照审核状态分页查询">3、按照审核状态分页查询</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts">&lt;a-form-item label=<span class="hljs-string">&quot;审核状态&quot;</span> name=<span class="hljs-string">&quot;reviewStatus&quot;</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">a-select</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">v-model:value</span>=<span class="hljs-string">&quot;searchParams.reviewStatus&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">:options</span>=<span class="hljs-string">&quot;PIC_REVIEW_STATUS_OPTIONS&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入审核状态&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;min-width: 180px&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">allow-clear</span></span></span><br><span class="hljs-tag"><span class="language-xml">  /&gt;</span></span><br>&lt;/a-form-item&gt;<br></code></pre></td></tr></table></figure>
<figure>
<img src="/img/pictureLibrary/image-20250718153633152.png" srcset="/img/loading.gif" lazyload
alt="image-20250718153633152" />
<figcaption aria-hidden="true">image-20250718153633152</figcaption>
</figure>
<p>这里有个小问题：用户被拒绝后是看不到自己被拒绝的图片的，后续做空间模块会做</p>
<h2 id="二url导入图片">二、URL导入图片</h2>
<h3 id="需求分析-1">需求分析</h3>
<p>除了上传本地图片，我们还可以开发一种通过输入URL，将远程图片保存到图库中的功能</p>
<h3 id="方案设计-1">方案设计</h3>
<p>1）下载图片</p>
<p>后端使用Hutool的HttpUtil包下的downloadFile函数下载</p>
<p>2）校验图片</p>
<p><strong>是下载到本地再校验，还是说有别的方法？</strong></p>
<p>我们可以对URL字符串本身校验是否完整，或者说可以获取请求头元信息(大小、格式等)，直接校验，节约流量。</p>
<p>3）上传图片</p>
<p>校验通过的，直接传入到COS服务器</p>
<h3 id="后端开发-1">后端开发</h3>
<h4 id="服务开发">1、服务开发</h4>
<p>URL上传图片大部分都是和之前写过的<code>uploadPicture</code>方法一致，只需要做以下更改</p>
<ul>
<li>参数类型：MultipartFile 类型改为String</li>
<li>校验图片：先前校验文件，现在校验URL</li>
<li>获取图片名称：URL获取名称</li>
<li>临时文件保存：先前是直接保存到临时文件，现在是URL下载文件然后存入临时文件中</li>
</ul>
<p>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> UploadPictureResult <span class="hljs-title function_">uploadPictureByUrl</span><span class="hljs-params">(String fileUrl, String uploadPathPrefix)</span> &#123;<br>       <span class="hljs-comment">// 校验图片</span><br>       validPicture(fileUrl);<br>       <span class="hljs-comment">// 图片上传地址</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> RandomUtil.randomString(<span class="hljs-number">16</span>);<br>       <span class="hljs-type">String</span> <span class="hljs-variable">originFilename</span> <span class="hljs-operator">=</span> FileUtil.mainName(fileUrl);<br>       <span class="hljs-type">String</span> <span class="hljs-variable">uploadFilename</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s_%s.%s&quot;</span>, DateUtil.formatDate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()), uuid,<br>               FileUtil.getSuffix(originFilename));<br>       <span class="hljs-type">String</span> <span class="hljs-variable">uploadPath</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;/%s/%s&quot;</span>, uploadPathPrefix, uploadFilename);<br>       <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-comment">// 创建临时文件</span><br>           file = File.createTempFile(uploadPath, <span class="hljs-literal">null</span>);<br>           HttpUtil.downloadFile(fileUrl,file);<br>           <span class="hljs-comment">// 上传图片</span><br>           <span class="hljs-type">PutObjectResult</span> <span class="hljs-variable">putObjectResult</span> <span class="hljs-operator">=</span> cosManager.putPictureObject(uploadPath, file);<br>           <span class="hljs-type">ImageInfo</span> <span class="hljs-variable">imageInfo</span> <span class="hljs-operator">=</span> putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();<br>           <span class="hljs-comment">// 封装返回结果</span><br>           <span class="hljs-type">UploadPictureResult</span> <span class="hljs-variable">uploadPictureResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadPictureResult</span>();<br>           <span class="hljs-type">int</span> <span class="hljs-variable">picWidth</span> <span class="hljs-operator">=</span> imageInfo.getWidth();<br>           <span class="hljs-type">int</span> <span class="hljs-variable">picHeight</span> <span class="hljs-operator">=</span> imageInfo.getHeight();<br>           <span class="hljs-type">double</span> <span class="hljs-variable">picScale</span> <span class="hljs-operator">=</span> NumberUtil.round(picWidth * <span class="hljs-number">1.0</span> / picHeight, <span class="hljs-number">2</span>).doubleValue();<br>           uploadPictureResult.setPicName(FileUtil.mainName(originFilename));<br>           uploadPictureResult.setPicWidth(picWidth);<br>           uploadPictureResult.setPicHeight(picHeight);<br>           uploadPictureResult.setPicScale(picScale);<br>           uploadPictureResult.setPicFormat(imageInfo.getFormat());<br>           uploadPictureResult.setPicSize(FileUtil.size(file));<br>           uploadPictureResult.setUrl(cosClientConfig.getHost() + <span class="hljs-string">&quot;/&quot;</span> + uploadPath);<br>           <span class="hljs-keyword">return</span> uploadPictureResult;<br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           log.error(<span class="hljs-string">&quot;图片上传到对象存储失败&quot;</span>, e);<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.SYSTEM_ERROR, <span class="hljs-string">&quot;上传失败&quot;</span>);<br>       &#125; <span class="hljs-keyword">finally</span> &#123;<br>           <span class="hljs-built_in">this</span>.deleteTempFile(file);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>
<h4 id="校验url">2、校验URL</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validPicture</span><span class="hljs-params">(String fileUrl)</span> &#123;<br>        ThrowUtils.throwIf(StrUtil.isBlank(fileUrl), ErrorCode.PARAMS_ERROR, <span class="hljs-string">&quot;URL地址不能为空&quot;</span>);<br><br>        <span class="hljs-comment">//1.校验URL格式</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(fileUrl);<br>        &#125; <span class="hljs-keyword">catch</span> (MalformedURLException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件格式不正确&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-comment">// 2. 校验协议</span><br>        ThrowUtils.throwIf(!(fileUrl.startsWith(<span class="hljs-string">&quot;http://&quot;</span>) || fileUrl.startsWith(<span class="hljs-string">&quot;https://&quot;</span>)),ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;仅支持Http和Https协议&quot;</span>);<br><br>        <span class="hljs-comment">//3. 发送HEAD请求验证文件是否存在</span><br>        <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            response = HttpUtil.createRequest(Method.HEAD,fileUrl).execute();<br><br>            <span class="hljs-keyword">if</span>(response.getStatus() != HttpStatus.HTTP_OK) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">//4. 校验文件类型</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> response.header(<span class="hljs-string">&quot;Content-Type&quot;</span>);<br>            <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(contentType)) &#123;<br>                <span class="hljs-keyword">final</span> List&lt;String&gt; ALLOW_CONTENT_TYPES = Arrays.asList(<span class="hljs-string">&quot;image/jpeg&quot;</span>,<span class="hljs-string">&quot;image/jpg&quot;</span>,<span class="hljs-string">&quot;image/png&quot;</span>,<span class="hljs-string">&quot;image/webp&quot;</span>);<br>                ThrowUtils.throwIf(!ALLOW_CONTENT_TYPES.contains(contentType.toLowerCase()),ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件类型错误&quot;</span>);<br>            &#125;<br><br><br>            <span class="hljs-comment">//5.校验文件大小</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">contentLengthStr</span> <span class="hljs-operator">=</span> response.header(<span class="hljs-string">&quot;Content-Length&quot;</span>);<br>            <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(contentLengthStr)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">contentLength</span> <span class="hljs-operator">=</span> Long.parseLong(contentLengthStr);<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TWO_MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024L</span>;<br>                    ThrowUtils.throwIf(contentLength &gt; TWO_MB,ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件大小不能超过2M&quot;</span>);<br>                &#125;<span class="hljs-keyword">catch</span> (NumberFormatException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件大小格式错误&quot;</span>);<br>                &#125;<br>            &#125;<br><br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span>(response != <span class="hljs-literal">null</span>) &#123;<br>                response.close();<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>注意</p>
<ul>
<li>发送HTTP请求后，最后需要释放资源</li>
<li>这里发送HEAD请求，HEAD请求访问失败不会报错，并且不用执行后续校验</li>
</ul>
<h4 id="代码优化">3、代码优化</h4>
<p>观察发现，代码方法重复，我们可以使用模版代码模式，将公共的部分提取出来</p>
<p>分析流程，我们的代码流程大抵都是</p>
<ul>
<li>校验图片、URL</li>
<li>构造上传地址</li>
<li>存储本地临时文件</li>
<li>上传</li>
<li>封装返回图片信息</li>
<li>清理</li>
</ul>
<p>我们可以将流程定义为抽象类，每一步都定义为一个抽象方法</p>
<p>接下来创建<code>/manager/upload</code>包，模版代码统一管理</p>
<p>1）定义上传图片模版抽象类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureUploadTemplate</span> &#123;  <br>  <br>    <span class="hljs-meta">@Resource</span>  <br>    <span class="hljs-keyword">protected</span> CosManager cosManager;  <br>  <br>    <span class="hljs-meta">@Resource</span>  <br>    <span class="hljs-keyword">protected</span> CosClientConfig cosClientConfig;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 模板方法，定义上传流程  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> UploadPictureResult <span class="hljs-title function_">uploadPicture</span><span class="hljs-params">(Object inputSource, String uploadPathPrefix)</span> &#123;  <br>        <span class="hljs-comment">// 1. 校验图片  </span><br>        validPicture(inputSource);  <br>  <br>        <span class="hljs-comment">// 2. 图片上传地址  </span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> RandomUtil.randomString(<span class="hljs-number">16</span>);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">originFilename</span> <span class="hljs-operator">=</span> getOriginFilename(inputSource);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">uploadFilename</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s_%s.%s&quot;</span>, DateUtil.formatDate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()), uuid,  <br>                FileUtil.getSuffix(originFilename));  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">uploadPath</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;/%s/%s&quot;</span>, uploadPathPrefix, uploadFilename);  <br>  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-comment">// 3. 创建临时文件  </span><br>            file = File.createTempFile(uploadPath, <span class="hljs-literal">null</span>);  <br>            <span class="hljs-comment">// 处理文件来源（本地或 URL）  </span><br>            processFile(inputSource, file);  <br>  <br>            <span class="hljs-comment">// 4. 上传图片到对象存储  </span><br>            <span class="hljs-type">PutObjectResult</span> <span class="hljs-variable">putObjectResult</span> <span class="hljs-operator">=</span> cosManager.putPictureObject(uploadPath, file);  <br>            <span class="hljs-type">ImageInfo</span> <span class="hljs-variable">imageInfo</span> <span class="hljs-operator">=</span> putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();  <br>  <br>            <span class="hljs-comment">// 5. 封装返回结果  </span><br>            <span class="hljs-keyword">return</span> buildResult(originFilename, file, uploadPath, imageInfo);  <br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>            log.error(<span class="hljs-string">&quot;图片上传到对象存储失败&quot;</span>, e);  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.SYSTEM_ERROR, <span class="hljs-string">&quot;上传失败&quot;</span>);  <br>        &#125; <span class="hljs-keyword">finally</span> &#123;  <br>            <span class="hljs-comment">// 6. 清理临时文件  </span><br>            deleteTempFile(file);  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 校验输入源（本地文件或 URL）  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validPicture</span><span class="hljs-params">(Object inputSource)</span>;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 获取输入源的原始文件名  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getOriginFilename</span><span class="hljs-params">(Object inputSource)</span>;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 处理输入源并生成本地临时文件  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFile</span><span class="hljs-params">(Object inputSource, File file)</span> <span class="hljs-keyword">throws</span> Exception;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 封装返回结果  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">private</span> UploadPictureResult <span class="hljs-title function_">buildResult</span><span class="hljs-params">(String originFilename, File file, String uploadPath, ImageInfo imageInfo)</span> &#123;  <br>        <span class="hljs-type">UploadPictureResult</span> <span class="hljs-variable">uploadPictureResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadPictureResult</span>();  <br>        <span class="hljs-type">int</span> <span class="hljs-variable">picWidth</span> <span class="hljs-operator">=</span> imageInfo.getWidth();  <br>        <span class="hljs-type">int</span> <span class="hljs-variable">picHeight</span> <span class="hljs-operator">=</span> imageInfo.getHeight();  <br>        <span class="hljs-type">double</span> <span class="hljs-variable">picScale</span> <span class="hljs-operator">=</span> NumberUtil.round(picWidth * <span class="hljs-number">1.0</span> / picHeight, <span class="hljs-number">2</span>).doubleValue();  <br>        uploadPictureResult.setPicName(FileUtil.mainName(originFilename));  <br>        uploadPictureResult.setPicWidth(picWidth);  <br>        uploadPictureResult.setPicHeight(picHeight);  <br>        uploadPictureResult.setPicScale(picScale);  <br>        uploadPictureResult.setPicFormat(imageInfo.getFormat());  <br>        uploadPictureResult.setPicSize(FileUtil.size(file));  <br>        uploadPictureResult.setUrl(cosClientConfig.getHost() + <span class="hljs-string">&quot;/&quot;</span> + uploadPath);  <br>        <span class="hljs-keyword">return</span> uploadPictureResult;  <br>    &#125;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 删除临时文件  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteTempFile</span><span class="hljs-params">(File file)</span> &#123;  <br>        <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span>) &#123;  <br>            <span class="hljs-keyword">return</span>;  <br>        &#125;  <br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">deleteResult</span> <span class="hljs-operator">=</span> file.delete();  <br>        <span class="hljs-keyword">if</span> (!deleteResult) &#123;  <br>            log.error(<span class="hljs-string">&quot;file delete error, filepath = &#123;&#125;&quot;</span>, file.getAbsolutePath());  <br>        &#125;  <br>    &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>上述代码将每一个公共的步骤都抽象出来了</p>
<p>为了同时兼容MultipartFile和String，定义统一类型Object</p>
<p>2）编写上传本地图片自类，继承抽象类，同时打上<code>@Service</code>生成Bean实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilePictureUpload</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PictureUploadTemplate</span> &#123;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validPicture</span><span class="hljs-params">(Object inputSource)</span> &#123;  <br>        <span class="hljs-type">MultipartFile</span> <span class="hljs-variable">multipartFile</span> <span class="hljs-operator">=</span> (MultipartFile) inputSource;  <br>        ThrowUtils.throwIf(multipartFile == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR, <span class="hljs-string">&quot;文件不能为空&quot;</span>);  <br>        <span class="hljs-comment">// 1. 校验文件大小  </span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">fileSize</span> <span class="hljs-operator">=</span> multipartFile.getSize();  <br>        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ONE_M</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024L</span>;  <br>        ThrowUtils.throwIf(fileSize &gt; <span class="hljs-number">2</span> * ONE_M, ErrorCode.PARAMS_ERROR, <span class="hljs-string">&quot;文件大小不能超过 2M&quot;</span>);  <br>        <span class="hljs-comment">// 2. 校验文件后缀  </span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> FileUtil.getSuffix(multipartFile.getOriginalFilename());  <br>        <span class="hljs-comment">// 允许上传的文件后缀  </span><br>        <span class="hljs-keyword">final</span> List&lt;String&gt; ALLOW_FORMAT_LIST = Arrays.asList(<span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>, <span class="hljs-string">&quot;webp&quot;</span>);  <br>        ThrowUtils.throwIf(!ALLOW_FORMAT_LIST.contains(fileSuffix), ErrorCode.PARAMS_ERROR, <span class="hljs-string">&quot;文件类型错误&quot;</span>);  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getOriginFilename</span><span class="hljs-params">(Object inputSource)</span> &#123;  <br>        <span class="hljs-type">MultipartFile</span> <span class="hljs-variable">multipartFile</span> <span class="hljs-operator">=</span> (MultipartFile) inputSource;  <br>        <span class="hljs-keyword">return</span> multipartFile.getOriginalFilename();  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFile</span><span class="hljs-params">(Object inputSource, File file)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">MultipartFile</span> <span class="hljs-variable">multipartFile</span> <span class="hljs-operator">=</span> (MultipartFile) inputSource;  <br>        multipartFile.transferTo(file);  <br>    &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>3）编写URL上传图片，继承模版类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kroot.krpicturebackend.manager.upload;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;<br><span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;<br><span class="hljs-keyword">import</span> cn.hutool.http.HttpResponse;<br><span class="hljs-keyword">import</span> cn.hutool.http.HttpStatus;<br><span class="hljs-keyword">import</span> cn.hutool.http.HttpUtil;<br><span class="hljs-keyword">import</span> cn.hutool.http.Method;<br><span class="hljs-keyword">import</span> com.kroot.krpicturebackend.exception.BusinessException;<br><span class="hljs-keyword">import</span> com.kroot.krpicturebackend.exception.ErrorCode;<br><span class="hljs-keyword">import</span> com.kroot.krpicturebackend.exception.ThrowUtils;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UrlPictureUpload</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PictureUploadTemplate</span> &#123;  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validPicture</span><span class="hljs-params">(Object inputSource)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileUrl</span> <span class="hljs-operator">=</span> (String) inputSource;  <br>        ThrowUtils.throwIf(StrUtil.isBlank(fileUrl), ErrorCode.PARAMS_ERROR, <span class="hljs-string">&quot;文件地址不能为空&quot;</span>);<br>        <span class="hljs-comment">//1.校验URL格式</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(fileUrl);<br>        &#125; <span class="hljs-keyword">catch</span> (MalformedURLException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件格式不正确&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-comment">// 2. 校验协议</span><br>        ThrowUtils.throwIf(!(fileUrl.startsWith(<span class="hljs-string">&quot;http://&quot;</span>) || fileUrl.startsWith(<span class="hljs-string">&quot;https://&quot;</span>)),ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;仅支持Http和Https协议&quot;</span>);<br><br>        <span class="hljs-comment">//3. 发送HEAD请求验证文件是否存在</span><br>        <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            response = HttpUtil.createRequest(Method.HEAD,fileUrl).execute();<br><br>            <span class="hljs-keyword">if</span>(response.getStatus() != HttpStatus.HTTP_OK) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">//4. 校验文件类型</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> response.header(<span class="hljs-string">&quot;Content-Type&quot;</span>);<br>            <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(contentType)) &#123;<br>                <span class="hljs-keyword">final</span> List&lt;String&gt; ALLOW_CONTENT_TYPES = Arrays.asList(<span class="hljs-string">&quot;image/jpeg&quot;</span>,<span class="hljs-string">&quot;image/jpg&quot;</span>,<span class="hljs-string">&quot;image/png&quot;</span>,<span class="hljs-string">&quot;image/webp&quot;</span>);<br>                ThrowUtils.throwIf(!ALLOW_CONTENT_TYPES.contains(contentType.toLowerCase()),ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件类型错误&quot;</span>);<br>            &#125;<br><br><br>            <span class="hljs-comment">//5.校验文件大小</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">contentLengthStr</span> <span class="hljs-operator">=</span> response.header(<span class="hljs-string">&quot;Content-Length&quot;</span>);<br>            <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(contentLengthStr)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">contentLength</span> <span class="hljs-operator">=</span> Long.parseLong(contentLengthStr);<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TWO_MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024L</span>;<br>                    ThrowUtils.throwIf(contentLength &gt; TWO_MB,ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件大小不能超过2M&quot;</span>);<br>                &#125;<span class="hljs-keyword">catch</span> (NumberFormatException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;文件大小格式错误&quot;</span>);<br>                &#125;<br>            &#125;<br><br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span>(response != <span class="hljs-literal">null</span>) &#123;<br>                response.close();<br>            &#125;<br>        &#125;<br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getOriginFilename</span><span class="hljs-params">(Object inputSource)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileUrl</span> <span class="hljs-operator">=</span> (String) inputSource;  <br>        <span class="hljs-comment">// 从 URL 中提取文件名  </span><br>        <span class="hljs-keyword">return</span> FileUtil.mainName(fileUrl);  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFile</span><span class="hljs-params">(Object inputSource, File file)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileUrl</span> <span class="hljs-operator">=</span> (String) inputSource;  <br>        <span class="hljs-comment">// 下载文件到临时目录  </span><br>        HttpUtil.downloadFile(fileUrl, file);  <br>    &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>优化完后，将原方法FileManager 打上<code>@Deprecated</code>注解</p>
<h4 id="图片上传服务支持url上传">4、图片上传服务支持URL上传</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PictureVO <span class="hljs-title function_">uploadPicture</span><span class="hljs-params">(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser)</span>;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PictureVO <span class="hljs-title function_">uploadPicture</span><span class="hljs-params">(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser)</span> &#123;<br>        ThrowUtils.throwIf(inputSource == <span class="hljs-literal">null</span>, ErrorCode.PARAMS_ERROR,<span class="hljs-string">&quot;图片为空&quot;</span>);<br>        <span class="hljs-comment">// 用于判断是新增还是更新图片</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">pictureId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (pictureUploadRequest != <span class="hljs-literal">null</span>) &#123;<br>            pictureId = pictureUploadRequest.getId();<br>        &#125;<br>        <span class="hljs-comment">// 如果是更新图片，需要校验图片是否存在</span><br>        <span class="hljs-keyword">if</span> (pictureId != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Picture</span> <span class="hljs-variable">oldPicture</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(pictureId);<br>            ThrowUtils.throwIf(oldPicture == <span class="hljs-literal">null</span>, ErrorCode.NOT_FOUND_ERROR,<span class="hljs-string">&quot;图片不存在&quot;</span>);<br><br>            <span class="hljs-keyword">if</span>(!oldPicture.getUserId().equals(loginUser.getId()) || !UserConstant.ADMIN_ROLE.equals(loginUser.getUserRole())) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.NO_AUTH_ERROR);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 上传图片，得到信息</span><br>        <span class="hljs-comment">// 按照用户 id 划分目录</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">uploadPathPrefix</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;public/%s&quot;</span>, loginUser.getId());<br>        <span class="hljs-type">PictureUploadTemplate</span> <span class="hljs-variable">pictureUploadTemplate</span> <span class="hljs-operator">=</span> filePictureUpload;<br><br>        <span class="hljs-keyword">if</span>(inputSource <span class="hljs-keyword">instanceof</span> String) &#123;<br>            pictureUploadTemplate = urlPictureUpload;<br>        &#125;<br><br>        <span class="hljs-type">UploadPictureResult</span> <span class="hljs-variable">uploadPictureResult</span> <span class="hljs-operator">=</span> pictureUploadTemplate.uploadPicture(inputSource,uploadPathPrefix);<br>        <span class="hljs-comment">// 构造要入库的图片信息</span><br>        <span class="hljs-type">Picture</span> <span class="hljs-variable">picture</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Picture</span>();<br>        picture.setUrl(uploadPictureResult.getUrl());<br>        picture.setName(uploadPictureResult.getPicName());<br>        picture.setPicSize(uploadPictureResult.getPicSize());<br>        picture.setPicWidth(uploadPictureResult.getPicWidth());<br>        picture.setPicHeight(uploadPictureResult.getPicHeight());<br>        picture.setPicScale(uploadPictureResult.getPicScale());<br>        picture.setPicFormat(uploadPictureResult.getPicFormat());<br>        picture.setUserId(loginUser.getId());<br>        fillReviewParams(picture,loginUser);<br>        <span class="hljs-comment">// 如果 pictureId 不为空，表示更新，否则是新增</span><br>        <span class="hljs-keyword">if</span> (pictureId != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 如果是更新，需要补充 id 和编辑时间</span><br>            picture.setId(pictureId);<br>            picture.setEditTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        &#125;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.saveOrUpdate(picture);<br>        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;图片上传失败&quot;</span>);<br>        <span class="hljs-keyword">return</span> PictureVO.objToVo(picture);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h4 id="接口开发">5、接口开发</h4>
<p>1）图片上传封装类新增fileUrl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureUploadRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图片 id（用于修改）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-keyword">private</span> String fileUrl;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>2）PictureController 新增<code>/upload/url</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/upload/url&quot;)</span><br><span class="hljs-keyword">public</span> BaseResponse&lt;PictureVO&gt; <span class="hljs-title function_">uploadPictureByUrl</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestBody</span> PictureUploadRequest pictureUploadRequest,</span><br><span class="hljs-params">        HttpServletRequest request)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> userService.getLoginUser(request);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileUrl</span> <span class="hljs-operator">=</span> pictureUploadRequest.getFileUrl();<br>    <span class="hljs-type">PictureVO</span> <span class="hljs-variable">pictureVO</span> <span class="hljs-operator">=</span> pictureService.uploadPicture(fileUrl, pictureUploadRequest, loginUser);<br>    <span class="hljs-keyword">return</span> ResultUtils.success(pictureVO);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="前端开发-1">前端开发</h3>
<p>我们先开发一个像上传本地图片一样的URL上传的界面</p>
<h4 id="开发url上传组件">1、开发URL上传组件</h4>
<p>输入框 + 提交按钮</p>
<p>这里使用<a
target="_blank" rel="noopener" href="https://antdv.com/components/input-cn#components-input-demo-group">复合输入框</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;div class=&quot;url-picture-upload&quot;&gt;  <br>  &lt;a-input-group compact style=&quot;margin-bottom: 16px&quot;&gt;  <br>    &lt;a-input v-model:value=&quot;fileUrl&quot; style=&quot;width: calc(100% - 120px)&quot; placeholder=&quot;请输入图片 URL&quot; /&gt;  <br>    &lt;a-button type=&quot;primary&quot; :loading=&quot;loading&quot; @click=&quot;handleUpload&quot; style=&quot;width: 120px&quot;&gt;提交&lt;/a-button&gt;  <br>  &lt;/a-input-group&gt;  <br>  &lt;img v-if=&quot;picture?.url&quot; :src=&quot;picture?.url&quot; alt=&quot;avatar&quot; /&gt;  <br>&lt;/div&gt;<br><br></code></pre></td></tr></table></figure>
<p>调用后端接口</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> loading = ref&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>)  <br><span class="hljs-keyword">const</span> fileUrl = ref&lt;<span class="hljs-built_in">string</span>&gt;()  <br>  <br><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * 上传  </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUpload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;  <br>  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-variable constant_">API</span>.<span class="hljs-property">PictureUploadRequest</span> = &#123; <span class="hljs-attr">fileUrl</span>: fileUrl.<span class="hljs-property">value</span> &#125;  <br>    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">picture</span>) &#123;  <br>      params.<span class="hljs-property">id</span> = props.<span class="hljs-property">picture</span>.<span class="hljs-property">id</span>  <br>    &#125;  <br>    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadPictureByUrlUsingPost</span>(params)  <br>    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">0</span> &amp;&amp; res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>) &#123;  <br>      message.<span class="hljs-title function_">success</span>(<span class="hljs-string">&#x27;图片上传成功&#x27;</span>)  <br>      <span class="hljs-comment">// 将上传成功的图片信息传递给父组件  </span><br>      props.<span class="hljs-property">onSuccess</span>?.(res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>)  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>      message.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;图片上传失败，&#x27;</span> + res.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>)  <br>    &#125;  <br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;  <br>    message.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;图片上传失败&#x27;</span>)  <br>  &#125; <span class="hljs-keyword">finally</span> &#123;  <br>    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>  <br>  &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<h4 id="开发创建页面">2、开发创建页面</h4>
<p>之前做了上传本地图片，我们可以将这两种方式通过<a
target="_blank" rel="noopener" href="https://antdv.com/components/tabs-cn">Tabs</a>包裹，用户去自己选择</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;a-tabs v-model:activeKey=&quot;uploadType&quot;<br>&gt;&gt;<br>  &lt;a-tab-pane key=&quot;file&quot; tab=&quot;文件上传&quot;&gt;<br>    &lt;PictureUpload :picture=&quot;picture&quot; :onSuccess=&quot;onSuccess&quot; /&gt;<br>  &lt;/a-tab-pane&gt;<br>  &lt;a-tab-pane key=&quot;url&quot; tab=&quot;URL 上传&quot; force-render&gt;<br>    &lt;UrlPictureUpload :picture=&quot;picture&quot; :onSuccess=&quot;onSuccess&quot; /&gt;<br>  &lt;/a-tab-pane&gt;<br>&lt;/a-tabs&gt;<br></code></pre></td></tr></table></figure>
<p>默认情况下选择file本地上传</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> uploadType = ref&lt;<span class="hljs-string">&#x27;file&#x27;</span> | <span class="hljs-string">&#x27;url&#x27;</span>&gt;(<span class="hljs-string">&#x27;file&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>效果如下</p>
<figure>
<img src="/img/pictureLibrary/image-20250718175408869.png" srcset="/img/loading.gif" lazyload
alt="image-20250718175408869" />
<figcaption aria-hidden="true">image-20250718175408869</figcaption>
</figure>
<h2 id="三批量抓取和创建图片">三、批量抓取和创建图片</h2>
<h3 id="需求分析-2">需求分析</h3>
<p>为了快速丰富我们的图库，我们需要利用爬虫去网上抓取数据</p>
<p>这个功能只能给普通用户开放权限，防止网站被目标源封IP</p>
<h3 id="方案设计-2">方案设计</h3>
<ul>
<li>怎么抓图片</li>
<li>抓取和导入规则</li>
</ul>
<h4 id="如何抓取图片">1、如何抓取图片</h4>
<p>因为大部分图片资源网站都是有版权，推荐在搜索引擎中抓取，这里我们选择bing
图库</p>
<p>可以看到有很多图片，接下俩我们怎么抓取呢？</p>
<figure>
<img src="/img/pictureLibrary/image-20250718175928544.png" srcset="/img/loading.gif" lazyload
alt="image-20250718175928544" />
<figcaption aria-hidden="true">image-20250718175928544</figcaption>
</figure>
<p>这里分为两种方法</p>
<ul>
<li>解析网站HTML页面，提取图片地址，再通过URL下载</li>
<li>直接调用后端图片地址接口</li>
</ul>
<p>如何获取到获取图片地址接口？</p>
<p>打开F12网络，在主页刷新我们并不清楚哪一个是调用后端获取图片的接口</p>
<p>但是你想网页往往采用懒加载，那我们向下滑动去刷新新页面，那不就会调用后端接口</p>
<figure>
<img src="/img/pictureLibrary/image-20250718181030548.png" srcset="/img/loading.gif" lazyload
alt="image-20250718181030548" />
<figcaption aria-hidden="true">image-20250718181030548</figcaption>
</figure>
<p>我们会发现他请求的网址是<code>https://cn.bing.com/images/async?....</code>拿到url一个一个删除属性，最终可以确定https://cn.bing.com/images/async?q=s&amp;mmasync=1是我们想要的获取图片数据的接口</p>
<p>由于该接口返回的是HTML文档，我们可以使用Java中的jsoup解析图片地址</p>
<p>但是需要我们提前知道图片的标签元素，最外层我们可以定位到dgControl，内层我们会发现每张图片都设置了<code>class=ming</code></p>
<figure>
<img src="/img/pictureLibrary/image-20250718182100989.png" srcset="/img/loading.gif" lazyload
alt="image-20250718182100989" />
<figcaption aria-hidden="true">image-20250718182100989</figcaption>
</figure>
<p>注意：图片附加参数需要清除，否则会影响图片质量，还会因为转义字符报错</p>
<h4 id="抓取和导入规则">2、抓取和导入规则</h4>
<p>在抓取前，我们应该明确管理员传入参数</p>
<ul>
<li>关键词</li>
<li>抓取数量</li>
</ul>
<h3 id="后端">后端</h3>
<h4 id="封装请求题">1、封装请求题</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureUploadByBatchRequest</span> &#123;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 搜索词  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">private</span> String searchText;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 抓取数量  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;  <br>&#125;<br><br></code></pre></td></tr></table></figure>
<h4 id="服务开发-1">2、服务开发</h4>
<p>1）引入jsoup</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- HTML 解析：https://jsoup.org/ --&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jsoup<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsoup<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.15.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>
<p>2）开发批量抓取服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Integer <span class="hljs-title function_">uploadPictureByBatch</span><span class="hljs-params">(PictureUploadByBatchRequest pictureUploadByBatchRequest, User loginUser)</span>;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">uploadPictureByBatch</span><span class="hljs-params">(PictureUploadByBatchRequest pictureUploadByBatchRequest, User loginUser)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">searchText</span> <span class="hljs-operator">=</span> pictureUploadByBatchRequest.getSearchText();<br>        <span class="hljs-comment">// 格式化数量</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> pictureUploadByBatchRequest.getCount();<br>        ThrowUtils.throwIf(count &gt; <span class="hljs-number">30</span>, ErrorCode.PARAMS_ERROR, <span class="hljs-string">&quot;最多 30 条&quot;</span>);<br>        <span class="hljs-comment">// 要抓取的地址</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fetchUrl</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;https://cn.bing.com/images/async?q=%s&amp;mmasync=1&quot;</span>, searchText);<br>        Document document;<br>        <span class="hljs-keyword">try</span> &#123;<br>            document = Jsoup.connect(fetchUrl).get();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">&quot;获取页面失败&quot;</span>, e);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;获取页面失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Element</span> <span class="hljs-variable">div</span> <span class="hljs-operator">=</span> document.getElementsByClass(<span class="hljs-string">&quot;dgControl&quot;</span>).first();<br>        <span class="hljs-keyword">if</span> (ObjUtil.isNull(div)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="hljs-string">&quot;获取元素失败&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Elements</span> <span class="hljs-variable">imgElementList</span> <span class="hljs-operator">=</span> div.select(<span class="hljs-string">&quot;img.mimg&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">uploadCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Element imgElement : imgElementList) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileUrl</span> <span class="hljs-operator">=</span> imgElement.attr(<span class="hljs-string">&quot;src&quot;</span>);<br>            <span class="hljs-keyword">if</span> (StrUtil.isBlank(fileUrl)) &#123;<br>                log.info(<span class="hljs-string">&quot;当前链接为空，已跳过: &#123;&#125;&quot;</span>, fileUrl);<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">// 处理图片上传地址，防止出现转义问题</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">questionMarkIndex</span> <span class="hljs-operator">=</span> fileUrl.indexOf(<span class="hljs-string">&quot;?&quot;</span>);<br>            <span class="hljs-keyword">if</span> (questionMarkIndex &gt; -<span class="hljs-number">1</span>) &#123;<br>                fileUrl = fileUrl.substring(<span class="hljs-number">0</span>, questionMarkIndex);<br>            &#125;<br>            <span class="hljs-comment">// 上传图片</span><br>            <span class="hljs-type">PictureUploadRequest</span> <span class="hljs-variable">pictureUploadRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureUploadRequest</span>();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">PictureVO</span> <span class="hljs-variable">pictureVO</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.uploadPicture(fileUrl, pictureUploadRequest, loginUser);<br>                log.info(<span class="hljs-string">&quot;图片上传成功, id = &#123;&#125;&quot;</span>, pictureVO.getId());<br>                uploadCount++;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;图片上传失败&quot;</span>, e);<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (uploadCount &gt;= count) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> uploadCount;<br>    &#125;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果想要抓取更多数量，建议设置<code>Thread.sleep</code>等待一段时间再抓</p>
<h4 id="接口开发-1">3、接口开发</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/upload/batch&quot;)</span><br><span class="hljs-meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span><br><span class="hljs-keyword">public</span> BaseResponse&lt;Integer&gt; <span class="hljs-title function_">uploadPictureByBatch</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestBody</span> PictureUploadByBatchRequest pictureUploadByBatchRequest,</span><br><span class="hljs-params">        HttpServletRequest request)</span> &#123;<br>    ThrowUtils.throwIf(pictureUploadByBatchRequest == <span class="hljs-literal">null</span>,ErrorCode.PARAMS_ERROR);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> userService.getLoginUser(request);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">uploadCount</span> <span class="hljs-operator">=</span> pictureService.uploadPictureByBatch(pictureUploadByBatchRequest,loginUser);<br>    <span class="hljs-keyword">return</span> ResultUtils.success(uploadCount);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="批量插入图片设置名称">4、批量插入图片设置名称</h4>
<p>我们批量导入的图片的名称取决于其URL，名称是乱七八糟的，我们其实可以在搜索关键词的基础上加上后缀</p>
<p>例如搜索 美食，获取到的图片是美食1，美食2。。。。</p>
<p>下面介绍如何实现</p>
<p>1）PictureUploadByBatchRequest请求类添加namePrefix字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> String namePrefix;<br></code></pre></td></tr></table></figure>
<p>2）图片名称是在uploadPicture方法中通过UploadPictureResult
设置给图片的，如果像自定义，可以在该方法PictureUploadRequest
补充参数picName</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> String picName;<br></code></pre></td></tr></table></figure>
<p>3）修改服务方法，设置名称为我们自定义的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Picture</span> <span class="hljs-variable">picture</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Picture</span>();<br>picture.setUrl(uploadPictureResult.getUrl());<br><span class="hljs-type">String</span> <span class="hljs-variable">picName</span> <span class="hljs-operator">=</span> uploadPictureResult.getPicName();<br><span class="hljs-keyword">if</span>(pictureUploadRequest != <span class="hljs-literal">null</span> &amp;&amp; StrUtil.isNotBlank(pictureUploadRequest.getPicName())) &#123;<br>  picName = pictureUploadRequest.getPicName();<br>&#125;<br>picture.setName(picName);<br></code></pre></td></tr></table></figure>
<p>4）修改批量上传服务方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">namePrefix</span> <span class="hljs-operator">=</span> pictureUploadByBatchRequest.getNamePrefix();<br><span class="hljs-comment">// 上传图片</span><br><span class="hljs-type">PictureUploadRequest</span> <span class="hljs-variable">pictureUploadRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PictureUploadRequest</span>();<br><span class="hljs-keyword">if</span>(StrUtil.isNotBlank(namePrefix)) &#123;<br>	pictureUploadRequest.setPicName(namePrefix + (uploadCount + <span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="接口测试">5、接口测试</h4>
<figure>
<img src="/img/pictureLibrary/image-20250719115455843.png" srcset="/img/loading.gif" lazyload
alt="image-20250719115455843" />
<figcaption aria-hidden="true">image-20250719115455843</figcaption>
</figure>
<h3 id="前端开发-2">前端开发</h3>
<p>刚刚我们已经完成了批量创建的接口，接下来需要创建批量创建的页面</p>
<h4 id="图片管理页面补充批量创建">1、图片管理页面补充批量创建</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;a-space&gt;  <br>  &lt;a-button type=&quot;primary&quot; href=&quot;/add_picture&quot; target=&quot;_blank&quot;&gt;+ 创建图片&lt;/a-button&gt;  <br>  &lt;a-button type=&quot;primary&quot; href=&quot;/add_picture/batch&quot; target=&quot;_blank&quot; ghost&gt;+ 批量创建图片&lt;/a-button&gt;  <br>&lt;/a-space&gt;<br><br></code></pre></td></tr></table></figure>
<p>效果如下</p>
<figure>
<img src="/img/pictureLibrary/image-20250719115822048.png" srcset="/img/loading.gif" lazyload
alt="image-20250719115822048" />
<figcaption aria-hidden="true">image-20250719115822048</figcaption>
</figure>
<h4 id="开发批量创建页面">2、开发批量创建页面</h4>
<p>1）添加路由</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ts">&#123;<br>  <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/add_picture/batch&#x27;</span>,<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;批量创建图片&#x27;</span>,<br>  <span class="hljs-attr">component</span>: <span class="hljs-title class_">AddPictureBatchPage</span>,<br>&#125;,<br></code></pre></td></tr></table></figure>
<p>注意：这个页面是限制用户访问的</p>
<p>2）复制粘贴AddPicturePage，修改表单项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;div id=&quot;addPictureBatchPage&quot;&gt;  <br>  &lt;h2 style=&quot;margin-bottom: 16px&quot;&gt;批量创建图片&lt;/h2&gt;  <br>  &lt;a-form layout=&quot;vertical&quot; :model=&quot;formData&quot; @finish=&quot;handleSubmit&quot;&gt;  <br>    &lt;a-form-item label=&quot;关键词&quot; name=&quot;searchText&quot;&gt;  <br>      &lt;a-input v-model:value=&quot;formData.searchText&quot; placeholder=&quot;请输入关键词&quot; /&gt;  <br>    &lt;/a-form-item&gt;  <br>    &lt;a-form-item label=&quot;抓取数量&quot; name=&quot;count&quot;&gt;  <br>      &lt;a-input-number  <br>        v-model:value=&quot;formData.count&quot;  <br>        placeholder=&quot;请输入数量&quot;  <br>        style=&quot;min-width: 180px&quot;  <br>        :min=&quot;1&quot;  <br>        :max=&quot;30&quot;  <br>        allow-clear  <br>      /&gt;  <br>    &lt;/a-form-item&gt;  <br>    &lt;a-form-item label=&quot;名称前缀&quot; name=&quot;namePrefix&quot;&gt;  <br>      &lt;a-input v-model:value=&quot;formData.namePrefix&quot; placeholder=&quot;请输入名称前缀，会自动补充序号&quot; /&gt;  <br>    &lt;/a-form-item&gt;  <br>    &lt;a-form-item&gt;  <br>      &lt;a-button type=&quot;primary&quot; html-type=&quot;submit&quot; style=&quot;width: 100%&quot; :loading=&quot;loading&quot;&gt;  <br>        执行任务  <br>      &lt;/a-button&gt;  <br>    &lt;/a-form-item&gt;  <br>  &lt;/a-form&gt;  <br>&lt;/div&gt;<br><br></code></pre></td></tr></table></figure>
<p>定义数据项以及加载情况</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> formData = reactive&lt;<span class="hljs-variable constant_">API</span>.<span class="hljs-property">PictureUploadByBatchRequest</span>&gt;(&#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-number">10</span><br>&#125;)<br><br><span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br></code></pre></td></tr></table></figure>
<h4 id="简单讲一下-ref和reactive的区别">简单讲一下
ref和reactive的区别</h4>
<table>
<thead>
<tr>
<th>ref</th>
<th>reactive</th>
</tr>
</thead>
<tbody>
<tr>
<td>修饰基本类型和对象</td>
<td>仅对象</td>
</tr>
<tr>
<td>需要通过.value访问</td>
<td>可以直接访问</td>
</tr>
<tr>
<td>解构后保持响应式</td>
<td>解构失去响应式可以通过toRefs解决</td>
</tr>
</tbody>
</table>
<p>添加样式</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-id">#addPictureBatchPage</span> &#123;<br>  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">720px</span>;<br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>3）编写提交函数</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadPictureByBatchUsingPost</span>(&#123;<br>    ...formData<br>  &#125;);<br><br>  <span class="hljs-keyword">if</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) &#123;<br>    message.<span class="hljs-title function_">success</span>(<span class="hljs-string">&#x27;批量创建成功&#x27;</span>)<br>    router.<span class="hljs-title function_">push</span>(&#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    &#125;)<br>  &#125;<span class="hljs-keyword">else</span> &#123;<br>    message.<span class="hljs-title function_">success</span>(<span class="hljs-string">&#x27;批量创建失败&#x27;</span> + res.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>)<br>  &#125;<br>  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>效果展示</p>
<figure>
<img src="/img/pictureLibrary/image-20250719121442242.png" srcset="/img/loading.gif" lazyload
alt="image-20250719121442242" />
<figcaption aria-hidden="true">image-20250719121442242</figcaption>
</figure>

                
              </div>
            
            <hr/>


                        <!-- 添加打赏模块 -->
            <div class="reward-container">
              
                <button id="rewardBtn" class="reward-btn">
                   
                    ❤ 打赏
                  	
                </button>
                <p class="tea">“觉得不错的话，给点打赏吧 ୧(๑•̀⌄•́๑)૭”</p>
                <div id="rewardImgContainer" class="reward-img-container">
                      <div class="singleImgContainer">
                          <img id="wechatImg" class="reward-img" src="/img/donate/wechat.jpg" srcset="/img/loading.gif" lazyload alt="微信二维码">
                            <p class="wechatPay">微信支付</p>
                        </div>
                        <div class="singleImgContainer">
                            <img id="alipayImg" class="reward-img" src="/img/donate/SS.jpg" srcset="/img/loading.gif" lazyload alt="支付宝二维码">
                            <p class="aliPay"></p>
                        </div>
                </div>
              
            </div>


            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="category-chain-item">项目实战</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="print-no-link">#项目实战</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>澄观云谱5-用户传图</div>
      <div>https://korinall.github.io/2025/07/18/澄观云谱05/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>KotRin</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年7月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/07/19/%E6%BE%84%E8%A7%82%E4%BA%91%E8%B0%B106/" title="澄观云谱6-图片优化">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">澄观云谱6-图片优化</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/07/16/%E6%BE%84%E8%A7%82%E4%BA%91%E8%B0%B104/" title="澄观云谱4-图片模块">
                        <span class="hidden-mobile">澄观云谱4-图片模块</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/waline.css')
      Fluid.utils.createScript('https://registry.npmmirror.com/@waline/client/2.15.8/files/dist/waline.js', function() {
        var options = Object.assign(
          {"serverURL":"https://kotrin.vercel.app/","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":0,"pageSize":10},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-xiangshangjiantou" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    


   
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/Cherry.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/star.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/love.min.js"></script>
<script src="/js/typing-effect.js"></script>
<script src="/js/reward.js"></script>
<script src="/js/APlayer.min.js"></script>
<script src="/js/Meting.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/go.js"></script><!-- hexo injector body_end end --></body>
</html>